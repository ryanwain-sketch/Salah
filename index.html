<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mo Salah vs Liverpool - Pixel Soccer</title>
    <!-- GameMonetize SDK for Ads -->
    <script src="https://api.gamemonetize.com/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Press Start 2P', monospace;
            overflow-x: hidden;
        }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        .game-container {
            text-align: center;
            padding: 10px;
        }

        h1 {
            color: #c8102e;
            font-size: 20px;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0 #000;
            font-family: 'Press Start 2P', monospace;
        }

        .score-board {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-family: 'Press Start 2P', monospace;
            flex-wrap: wrap;
        }

        .score {
            color: #fff;
            font-size: 12px;
        }

        .goals { color: #4ade80; }
        .saves { color: #f87171; }
        .level { color: #60a5fa; }
        .total { color: #ffd700; }

        canvas {
            border: 4px solid #c8102e;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(200, 16, 46, 0.5);
            image-rendering: pixelated;
            max-width: 100%;
            touch-action: none;
        }

        .instructions {
            color: #888;
            font-size: 8px;
            margin-top: 10px;
            font-family: 'Press Start 2P', monospace;
            line-height: 1.8;
        }

        .mobile-controls {
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 0 20px;
            width: 100%;
            max-width: 800px;
        }

        @media (pointer: coarse) {
            .mobile-controls { display: flex; }
            .instructions { display: none; }
        }

        .joystick-area {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            position: relative;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .joystick-knob {
            width: 40px;
            height: 40px;
            background: rgba(200, 16, 46, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #fff;
        }

        .shoot-btn {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #c8102e, #a00d24);
            border-radius: 50%;
            border: 4px solid #ffd700;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(200, 16, 46, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            color: #ffd700;
            font-size: 11px;
            margin-top: 10px;
            font-family: 'Press Start 2P', monospace;
            min-height: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .overlay.hidden { display: none; }

        .menu {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #c8102e;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .menu h2 {
            color: #c8102e;
            font-size: 18px;
            margin-bottom: 20px;
            font-family: 'Press Start 2P', monospace;
        }

        .menu input {
            padding: 12px;
            font-size: 14px;
            font-family: 'Press Start 2P', monospace;
            border: 3px solid #c8102e;
            border-radius: 8px;
            margin: 10px 0;
            width: 200px;
            text-align: center;
        }

        .menu button {
            padding: 15px 30px;
            font-size: 12px;
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(145deg, #c8102e, #a00d24);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.1s;
        }

        .menu button:hover {
            transform: scale(1.05);
        }

        .leaderboard {
            margin-top: 20px;
            text-align: left;
        }

        .leaderboard h3 {
            color: #ffd700;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        .leaderboard-entry {
            color: #fff;
            font-size: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .leaderboard-entry.gold { color: #ffd700; }
        .leaderboard-entry.silver { color: #c0c0c0; }
        .leaderboard-entry.bronze { color: #cd7f32; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>MO SALAH vs LIVERPOOL</h1>
        <div class="score-board">
            <span class="score level">LEVEL: <span id="level">1</span></span>
            <span class="score goals">GOALS: <span id="goals">0</span>/<span id="target">2</span></span>
            <span class="score total">TOTAL: <span id="totalScore">0</span></span>
        </div>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <div class="message" id="message">Hold SHOOT to power up!</div>
        <div class="instructions">
            ARROWS/WASD - Move | HOLD SPACE - Power shot | Avoid defenders!
        </div>
        <div class="mobile-controls">
            <div class="joystick-area" id="joystick">
                <div class="joystick-knob" id="knob"></div>
            </div>
            <button class="shoot-btn" id="shootBtn">SHOOT</button>
        </div>
    </div>

    <!-- Start Menu Overlay -->
    <div class="overlay" id="startOverlay">
        <div class="menu">
            <h2>MO SALAH<br>GOAL MACHINE</h2>
            <p style="color:#fff;font-size:10px;margin:15px 0;">Enter your name:</p>
            <input type="text" id="playerName" placeholder="YOUR NAME" maxlength="12">
            <br>
            <button id="startBtn">START GAME</button>
            <div class="leaderboard" id="leaderboard"></div>
        </div>
    </div>

    <!-- Ad Container -->
    <div class="overlay hidden" id="adOverlay">
        <div class="menu" style="padding:15px;">
            <p style="color:#ffd700;font-size:10px;margin-bottom:10px;">Loading ad...</p>
            <div id="gamemonetize-ad"></div>
        </div>
    </div>

    <!-- Level Complete Overlay -->
    <div class="overlay hidden" id="levelOverlay">
        <div class="menu">
            <h2 id="levelTitle">LEVEL COMPLETE!</h2>
            <p style="color:#4ade80;font-size:14px;margin:15px 0;" id="levelScore"></p>
            <p style="color:#fff;font-size:10px;margin:15px 0;" id="levelDesc"></p>
            <button id="nextLevelBtn">NEXT LEVEL</button>
            <button id="extraLifeBtn" style="background:linear-gradient(145deg,#22c55e,#16a34a);margin-top:5px;">ðŸ“º WATCH AD +1 LIFE</button>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div class="overlay hidden" id="gameOverOverlay">
        <div class="menu">
            <h2>GAME OVER</h2>
            <p style="color:#ffd700;font-size:16px;margin:15px 0;">Final Score: <span id="finalScore">0</span></p>
            <p style="color:#fff;font-size:10px;margin:15px 0;" id="gameOverMsg"></p>
            <button id="continueAdBtn" style="background:linear-gradient(145deg,#22c55e,#16a34a);">ðŸ“º WATCH AD TO CONTINUE</button>
            <button id="playAgainBtn">PLAY AGAIN</button>
            <button id="mainMenuBtn">MAIN MENU</button>
            <div class="leaderboard" id="gameOverLeaderboard"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Level configurations - easier start, gradual difficulty
        const levels = [
            { name: "Warm Up", target: 2, defenders: [], keeperSpeed: 0.012, desc: "Just you and Alisson. Easy start!" },
            { name: "Getting Started", target: 2, defenders: ['konate'], keeperSpeed: 0.015, defenderSpeed: 2.0, desc: "Konate joins but he's taking it easy!" },
            { name: "Van Dijk!", target: 2, defenders: ['konate', 'vandijk'], keeperSpeed: 0.018, defenderSpeed: 2.3, desc: "The big man Van Dijk arrives!" },
            { name: "Robertson Joins", target: 3, defenders: ['konate', 'vandijk', 'robertson'], keeperSpeed: 0.022, defenderSpeed: 2.5, desc: "Robertson adds to the defense!" },
            { name: "FREE KICK!", target: 1, defenders: [], keeperSpeed: 0.025, freeKick: true, wallSize: 3, desc: "Bonus Round! Bend it like Salah!" },
            { name: "Stepping Up", target: 3, defenders: ['konate', 'vandijk'], keeperSpeed: 0.028, defenderSpeed: 2.8, desc: "Defenders are getting serious!" },
            { name: "Full Squad", target: 3, defenders: ['konate', 'vandijk', 'robertson', 'bradley'], keeperSpeed: 0.032, defenderSpeed: 3.0, desc: "Bradley completes the back four!" },
            { name: "FINAL FREE KICK", target: 1, defenders: [], keeperSpeed: 0.035, freeKick: true, wallSize: 4, desc: "Bigger wall! Curve it in!" },
            { name: "Legend Mode", target: 4, defenders: ['konate', 'vandijk', 'robertson', 'bradley'], keeperSpeed: 0.04, defenderSpeed: 3.3, desc: "Prove you're a legend!" }
        ];

        // Game state
        let currentLevel = 0;
        let levelGoals = 0;
        let totalScore = 0;
        let lives = 5;
        let playerName = '';
        let gameState = 'menu'; // menu, playing, shooting, celebrating, saved, tackled, freeKick, bendSelect, gameOver

        // Free kick state
        let freeKickPhase = 'aim'; // aim, bend
        let bendAmount = 0;
        let bendDirection = 1;
        let wallPlayers = [];

        // Salah (player)
        const salah = {
            x: 200, y: 250, width: 32, height: 48, speed: 4,
            hasBall: true, kickFrame: 0, celebrating: false, celebrateFrame: 0
        };

        // Ball
        const ball = {
            x: 220, y: 270, radius: 8,
            velocityX: 0, velocityY: 0, curve: 0, active: false
        };

        // Alisson
        const alisson = {
            x: 700, y: 250, width: 36, height: 52,
            targetY: 250, speed: 3, diving: false, diveDirection: 0, diveFrame: 0
        };

        // Defenders
        const defenders = {
            konate: { x: 500, y: 250, speed: 2.5, tackleRange: 35, number: 5, skin: '#3d2314' },
            vandijk: { x: 450, y: 180, speed: 2.2, tackleRange: 38, number: 4, skin: '#d4a574' },
            robertson: { x: 480, y: 320, speed: 2.8, tackleRange: 32, number: 26, skin: '#f5d5c8' },
            bradley: { x: 420, y: 250, speed: 2.6, tackleRange: 30, number: 66, skin: '#f5d5c8' }
        };

        // Goal
        const goal = { x: 740, y: 150, width: 50, height: 200, postWidth: 8 };

        // Shot power
        let shotCharging = false;
        let shotPower = 0;
        let maxShotPower = 100;
        let chargeStartTime = 0;

        // Commentary
        const goalMessages = [
            'GOAL! The Egyptian King strikes!', 'SALAAAAH! What a finish!',
            'He makes it look so easy!', 'Running down the wing! SALAH!',
            'The Pharaoh has spoken!', 'Unstoppable from Mo Salah!',
            'Clinical finish! Pure class!', 'Alisson had no chance!',
            'WORLD CLASS!', 'The King of Egypt!'
        ];
        const saveMessages = [
            'SAVED by Alisson!', 'Great stop from Alisson!',
            'The Brazilian says NO!', 'Alisson stands tall!',
            'Denied by the keeper!', 'What a save! Alisson!'
        ];
        const missMessages = [
            'Over the bar! Too much power!', 'Blazed it over! So close!',
            'Into the stands!', 'Skied it!', 'Way too much on that one!'
        ];
        const tackleMessages = [
            'TACKLED!', 'Dispossessed!', 'Great defending!',
            'Ball won cleanly!', 'Reads it perfectly!'
        ];
        const freeKickMessages = [
            'WHAT A FREE KICK!', 'Bend it like Salah!',
            'Curled into the corner!', 'The wall had no chance!',
            'Absolutely magnificent!'
        ];

        function randomMessage(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Global Leaderboard using Dreamlo
        const DREAMLO_PRIVATE = 'plQDO2UdfEytCaRU9D0M3QjzvR1a9VJkaQBeFOXWkNUg';
        const DREAMLO_PUBLIC = '697e8e208f40bb1184cada44';
        let globalLeaderboard = [];

        async function fetchLeaderboard() {
            try {
                const response = await fetch(`https://www.dreamlo.com/lb/${DREAMLO_PUBLIC}/json`);
                const data = await response.json();
                if (data.dreamlo && data.dreamlo.leaderboard && data.dreamlo.leaderboard.entry) {
                    let entries = data.dreamlo.leaderboard.entry;
                    // Handle single entry (not array)
                    if (!Array.isArray(entries)) entries = [entries];
                    globalLeaderboard = entries.map(e => ({
                        name: e.name,
                        score: parseInt(e.score)
                    }));
                } else {
                    globalLeaderboard = [];
                }
            } catch (err) {
                console.log('Leaderboard fetch error:', err);
                // Fallback to local storage
                const data = localStorage.getItem('salahLeaderboard');
                globalLeaderboard = data ? JSON.parse(data) : [];
            }
            return globalLeaderboard;
        }

        async function saveScore(name, score) {
            // Save to local storage as backup
            const local = localStorage.getItem('salahLeaderboard');
            const leaderboard = local ? JSON.parse(local) : [];
            leaderboard.push({ name, score, date: Date.now() });
            leaderboard.sort((a, b) => b.score - a.score);
            localStorage.setItem('salahLeaderboard', JSON.stringify(leaderboard.slice(0, 50)));

            // Save to global Dreamlo leaderboard
            try {
                const safeName = encodeURIComponent(name.replace(/[^a-zA-Z0-9]/g, '').substring(0, 12) || 'PLAYER');
                await fetch(`https://www.dreamlo.com/lb/${DREAMLO_PRIVATE}/add/${safeName}/${score}`);
                console.log('Score saved globally!');
            } catch (err) {
                console.log('Error saving to global leaderboard:', err);
            }
        }

        async function displayLeaderboard(elementId) {
            const container = document.getElementById(elementId);
            if (!container) return;

            container.innerHTML = '<h3>GLOBAL LEADERBOARD</h3><p style="color:#888;font-size:10px;">Loading...</p>';

            await fetchLeaderboard();

            let html = '<h3>GLOBAL LEADERBOARD</h3>';
            const top10 = globalLeaderboard.slice(0, 10);
            if (top10.length === 0) {
                html += '<p style="color:#888;font-size:10px;">No scores yet! Be the first!</p>';
            } else {
                top10.forEach((entry, i) => {
                    let cls = '';
                    if (i === 0) cls = 'gold';
                    else if (i === 1) cls = 'silver';
                    else if (i === 2) cls = 'bronze';
                    html += `<div class="leaderboard-entry ${cls}">
                        <span>${i + 1}. ${entry.name}</span>
                        <span>${entry.score}</span>
                    </div>`;
                });
            }
            container.innerHTML = html;
        }

        // GameMonetize Ads
        const GAME_ID = '4kci7og3klgj0ivy2wz3gdvd9dth5e7n';
        let adCallback = null;
        let adsWatched = 0;

        function showAd(onComplete) {
            adCallback = onComplete;
            document.getElementById('adOverlay').classList.remove('hidden');

            if (typeof sdk !== 'undefined' && sdk.showBanner) {
                sdk.showBanner({
                    ê²Œìž„_id: GAME_ID,
                    ê²Œìž„_distribution: true
                }).then(() => {
                    adsWatched++;
                    document.getElementById('adOverlay').classList.add('hidden');
                    if (adCallback) adCallback(true);
                }).catch(() => {
                    document.getElementById('adOverlay').classList.add('hidden');
                    if (adCallback) adCallback(false);
                });
            } else {
                // Fallback: simulate ad for testing
                setTimeout(() => {
                    adsWatched++;
                    document.getElementById('adOverlay').classList.add('hidden');
                    if (adCallback) adCallback(true);
                }, 1500);
            }
        }

        function showRewardedAd(onReward) {
            showAd((success) => {
                if (success && onReward) onReward();
            });
        }

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === ' ') {
                handleShootPress();
                e.preventDefault();
            }
            if (e.key.toLowerCase() === 'r' && gameState === 'playing') {
                resetPositions();
            }
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            if (e.key === ' ') handleShootRelease();
        });

        // Mobile controls
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('knob');
        const shootBtn = document.getElementById('shootBtn');
        let joystickActive = false;
        let joystickCenter = { x: 0, y: 0 };
        let touchMove = { x: 0, y: 0 };

        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
            const rect = joystick.getBoundingClientRect();
            joystickCenter = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
        });

        document.addEventListener('touchmove', (e) => {
            if (!joystickActive) return;
            e.preventDefault();
            const touch = e.touches[0];
            const maxDist = 30;
            let dx = touch.clientX - joystickCenter.x;
            let dy = touch.clientY - joystickCenter.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > maxDist) { dx = (dx / dist) * maxDist; dy = (dy / dist) * maxDist; }
            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            touchMove = { x: dx / maxDist, y: dy / maxDist };
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (joystickActive) {
                joystickActive = false;
                knob.style.transform = 'translate(-50%, -50%)';
                touchMove = { x: 0, y: 0 };
            }
        });

        shootBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleShootPress(); });
        shootBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleShootRelease(); });

        function handleShootPress() {
            if (gameState === 'playing' && salah.hasBall && !shotCharging) {
                startCharging();
            } else if (gameState === 'freeKick' && freeKickPhase === 'aim' && !shotCharging) {
                startCharging();
            } else if (gameState === 'bendSelect') {
                // Confirm bend and shoot
                shootFreeKick();
            }
        }

        function handleShootRelease() {
            if (shotCharging) {
                if (gameState === 'playing' && salah.hasBall) {
                    shootBall(shotPower);
                } else if (gameState === 'freeKick' && freeKickPhase === 'aim') {
                    // Move to bend selection
                    freeKickPhase = 'bend';
                    gameState = 'bendSelect';
                    bendAmount = 50;
                    document.getElementById('message').textContent = 'Choose BEND! Press SHOOT to confirm!';
                }
                shotCharging = false;
                shotPower = 0;
            }
        }

        function startCharging() {
            shotCharging = true;
            chargeStartTime = Date.now();
            shotPower = 0;
        }

        function shootBall(power) {
            gameState = 'shooting';
            salah.hasBall = false;
            salah.kickFrame = 10;

            const powerPercent = power / maxShotPower;
            const basePower = 10 + powerPercent * 8;
            const aimVariance = (Math.random() - 0.5) * 60;

            let goingOver = false;
            if (powerPercent > 0.75 && Math.random() < (powerPercent - 0.5) * 0.8) {
                goingOver = true;
            }

            ball.targetY = goingOver ? goal.y - 50 - Math.random() * 100 : goal.y + goal.height / 2 + aimVariance;
            ball.active = true;
            ball.velocityX = basePower;
            ball.velocityY = (ball.targetY - ball.y) / ((goal.x - ball.x) / basePower);
            ball.curve = 0;

            const level = levels[currentLevel];
            const reactionDelay = 100 + Math.random() * 150 + (powerPercent * 50);
            setTimeout(() => {
                if (gameState === 'shooting') {
                    const predictedY = ball.y + ball.velocityY * ((alisson.x - ball.x) / ball.velocityX);
                    alisson.targetY = predictedY;
                    alisson.diving = true;
                    alisson.diveDirection = predictedY > alisson.y ? 1 : -1;
                }
            }, reactionDelay);
        }

        function shootFreeKick() {
            gameState = 'shooting';
            salah.kickFrame = 10;

            const power = shotPower || 60;
            const powerPercent = power / maxShotPower;
            const basePower = 8 + powerPercent * 6;

            // Bend affects curve - more bend = more curve but harder to control
            const bendPercent = (bendAmount - 50) / 50; // -1 to 1
            ball.curve = bendPercent * 0.3;

            // Target based on bend
            const targetY = goal.y + goal.height / 2 + bendPercent * 80;

            ball.active = true;
            ball.velocityX = basePower;
            ball.velocityY = (targetY - ball.y) / ((goal.x - ball.x) / basePower) - ball.curve * 5;

            // High bend = risk of missing
            if (Math.abs(bendPercent) > 0.7 && Math.random() < Math.abs(bendPercent) * 0.3) {
                ball.velocityY += (Math.random() - 0.5) * 4;
            }

            const level = levels[currentLevel];
            setTimeout(() => {
                if (gameState === 'shooting') {
                    const predictedY = ball.y + ball.velocityY * ((alisson.x - ball.x) / ball.velocityX);
                    alisson.targetY = predictedY + ball.curve * 50; // Keeper misjudges curve
                    alisson.diving = true;
                    alisson.diveDirection = predictedY > alisson.y ? 1 : -1;
                }
            }, 150);
        }

        function resetPositions() {
            const level = levels[currentLevel];

            if (level.freeKick) {
                salah.x = 400;
                salah.y = 350;
                ball.x = 420;
                ball.y = 365;
                gameState = 'freeKick';
                freeKickPhase = 'aim';
                setupWall(level.wallSize || 4);
                document.getElementById('message').textContent = 'Hold SHOOT for power!';
            } else {
                salah.x = 200;
                salah.y = 250;
                ball.x = 220;
                ball.y = 270;
                gameState = 'playing';
                document.getElementById('message').textContent = 'Hold SHOOT to power up!';
            }

            salah.hasBall = true;
            salah.kickFrame = 0;
            salah.celebrating = false;
            salah.celebrateFrame = 0;
            ball.active = false;
            ball.velocityX = 0;
            ball.velocityY = 0;
            ball.curve = 0;
            alisson.x = 700;
            alisson.y = 250;
            alisson.diving = false;
            alisson.diveFrame = 0;
            shotCharging = false;
            shotPower = 0;

            // Reset defenders
            const defSpeed = level.defenderSpeed || 2.0;
            defenders.konate.x = 500; defenders.konate.y = 250; defenders.konate.speed = defSpeed;
            defenders.vandijk.x = 450; defenders.vandijk.y = 180; defenders.vandijk.speed = defSpeed * 0.9;
            defenders.robertson.x = 480; defenders.robertson.y = 320; defenders.robertson.speed = defSpeed * 1.1;
            defenders.bradley.x = 420; defenders.bradley.y = 250; defenders.bradley.speed = defSpeed * 1.05;
        }

        function setupWall(size) {
            wallPlayers = [];
            const startY = goal.y + goal.height / 2 - (size * 25) / 2;
            for (let i = 0; i < size; i++) {
                wallPlayers.push({ x: 550, y: startY + i * 25, width: 20, height: 45 });
            }
        }

        function startLevel(levelIndex) {
            currentLevel = levelIndex;
            levelGoals = 0;
            const level = levels[currentLevel];
            document.getElementById('level').textContent = currentLevel + 1;
            document.getElementById('target').textContent = level.target;
            document.getElementById('goals').textContent = '0';
            resetPositions();
            document.getElementById('levelOverlay').classList.add('hidden');
        }

        function completeLevel() {
            const level = levels[currentLevel];
            const bonus = level.freeKick ? 50 : level.target * 10;
            totalScore += bonus;
            document.getElementById('totalScore').textContent = totalScore;

            if (currentLevel < levels.length - 1) {
                document.getElementById('levelTitle').textContent = 'LEVEL COMPLETE!';
                document.getElementById('levelScore').textContent = `+${bonus} points!`;
                document.getElementById('levelDesc').textContent = levels[currentLevel + 1].desc;
                document.getElementById('levelOverlay').classList.remove('hidden');
                gameState = 'levelComplete';
            } else {
                // Game complete!
                endGame(true);
            }
        }

        async function endGame(completed) {
            gameState = 'gameOver';
            document.getElementById('finalScore').textContent = totalScore;
            document.getElementById('gameOverMsg').textContent = completed
                ? 'INCREDIBLE! You completed all levels!'
                : `You reached Level ${currentLevel + 1}`;
            document.getElementById('gameOverOverlay').classList.remove('hidden');

            // Save score and refresh leaderboard
            await saveScore(playerName, totalScore);
            await displayLeaderboard('gameOverLeaderboard');
        }

        function handleGoal() {
            levelGoals++;
            totalScore += 10;
            document.getElementById('goals').textContent = levelGoals;
            document.getElementById('totalScore').textContent = totalScore;

            const level = levels[currentLevel];
            const isFreeKick = level.freeKick;
            document.getElementById('message').textContent = isFreeKick
                ? randomMessage(freeKickMessages)
                : randomMessage(goalMessages);

            gameState = 'celebrating';
            salah.celebrating = true;
            salah.celebrateFrame = 0;

            setTimeout(() => {
                if (levelGoals >= level.target) {
                    completeLevel();
                } else {
                    resetPositions();
                }
            }, 2000);
        }

        function handleMiss(isSave) {
            lives--;
            document.getElementById('message').textContent = isSave
                ? randomMessage(saveMessages)
                : randomMessage(missMessages);
            gameState = 'saved';

            if (lives <= 0) {
                setTimeout(() => endGame(false), 1500);
            } else {
                setTimeout(resetPositions, 1500);
            }
        }

        function handleTackle(defenderName) {
            lives--;
            const name = defenderName.charAt(0).toUpperCase() + defenderName.slice(1).replace('-', ' ');
            document.getElementById('message').textContent = `${name}: ${randomMessage(tackleMessages)}`;
            gameState = 'tackled';

            if (lives <= 0) {
                setTimeout(() => endGame(false), 1500);
            } else {
                setTimeout(resetPositions, 1500);
            }
        }

        // Drawing functions
        function drawField() {
            ctx.fillStyle = '#2d5a27';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#347a2c';
            for (let i = 0; i < canvas.width; i += 60) ctx.fillRect(i, 0, 30, canvas.height);

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.strokeRect(600, 100, 200, 300);
            ctx.strokeRect(700, 175, 100, 150);

            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(650, 250, 4, 0, Math.PI * 2);
            ctx.fill();

            // Free kick spot
            if (levels[currentLevel]?.freeKick) {
                ctx.beginPath();
                ctx.arc(420, 365, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Goal
            ctx.fillStyle = '#fff';
            ctx.fillRect(goal.x, goal.y, goal.postWidth, goal.height);
            ctx.fillRect(goal.x, goal.y, goal.width, goal.postWidth);
            ctx.fillRect(goal.x, goal.y + goal.height - goal.postWidth, goal.width, goal.postWidth);

            // Net
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            for (let i = goal.y; i < goal.y + goal.height; i += 15) {
                ctx.beginPath(); ctx.moveTo(goal.x + goal.postWidth, i); ctx.lineTo(goal.x + goal.width, i); ctx.stroke();
            }
            for (let i = goal.x + goal.postWidth; i < goal.x + goal.width; i += 15) {
                ctx.beginPath(); ctx.moveTo(i, goal.y); ctx.lineTo(i, goal.y + goal.height); ctx.stroke();
            }

            // Lives indicator
            ctx.fillStyle = '#c8102e';
            for (let i = 0; i < lives; i++) {
                ctx.beginPath();
                ctx.arc(30 + i * 25, 25, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawSalah(x, y) {
            const skinColor = '#c68642';
            const hairColor = '#1a1a1a';
            const shirtColor = '#c8102e';

            // Curly hair
            ctx.fillStyle = hairColor;
            ctx.fillRect(x + 4, y - 4, 24, 12);
            ctx.fillRect(x, y, 8, 8);
            ctx.fillRect(x + 24, y, 8, 8);
            ctx.fillRect(x + 2, y + 6, 6, 8);
            ctx.fillRect(x + 24, y + 6, 6, 8);

            // Head
            ctx.fillStyle = skinColor;
            ctx.fillRect(x + 6, y + 4, 20, 18);

            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 10, y + 10, 4, 4);
            ctx.fillRect(x + 18, y + 10, 4, 4);

            // Beard
            ctx.fillStyle = hairColor;
            ctx.fillRect(x + 6, y + 16, 20, 6);
            ctx.fillRect(x + 10, y + 14, 12, 4);

            // Body
            ctx.fillStyle = shirtColor;
            ctx.fillRect(x + 4, y + 22, 24, 18);

            // Number 11
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 10, y + 26, 3, 10);
            ctx.fillRect(x + 18, y + 26, 3, 10);

            // Arms
            ctx.fillStyle = shirtColor;
            ctx.fillRect(x - 2, y + 22, 8, 14);
            ctx.fillRect(x + 26, y + 22, 8, 14);

            // Hands
            ctx.fillStyle = skinColor;
            ctx.fillRect(x - 2, y + 34, 6, 6);
            ctx.fillRect(x + 28, y + 34, 6, 6);

            // Shorts & legs
            ctx.fillStyle = shirtColor;
            ctx.fillRect(x + 6, y + 40, 20, 10);
            ctx.fillStyle = skinColor;
            ctx.fillRect(x + 8, y + 50, 6, 10);
            ctx.fillRect(x + 18, y + 50, 6, 10);

            // Boots
            ctx.fillStyle = '#f97316';
            ctx.fillRect(x + 6, y + 58, 10, 6);
            ctx.fillRect(x + 16, y + 58, 10, 6);

            // Kick animation
            if (salah.kickFrame > 0) {
                ctx.fillStyle = skinColor;
                ctx.fillRect(x + 24, y + 48, 12, 6);
                ctx.fillStyle = '#f97316';
                ctx.fillRect(x + 32, y + 48, 10, 6);
            }

            // Celebration
            if (salah.celebrating) {
                const jump = Math.sin(salah.celebrateFrame * 0.3) * 10;
                const wave = Math.sin(salah.celebrateFrame * 0.5) * 8;
                ctx.fillStyle = shirtColor;
                ctx.fillRect(x - 6, y + 10 - jump + wave, 10, 16);
                ctx.fillRect(x + 28, y + 10 - jump - wave, 10, 16);
                ctx.fillStyle = skinColor;
                ctx.fillRect(x - 6, y + 4 - jump + wave, 8, 8);
                ctx.fillRect(x + 30, y + 4 - jump - wave, 8, 8);
            }
        }

        function drawAlisson(x, y, diving, diveDir) {
            const skinColor = '#d4a574';
            const hairColor = '#4a3728';
            const shirtColor = '#32CD32';
            const shortsColor = '#228B22';
            const glovesColor = '#FFD700';

            if (diving) {
                const offset = Math.min(alisson.diveFrame * 3, 40) * diveDir;
                y += offset;
                ctx.fillStyle = shirtColor;
                ctx.fillRect(x - 8, y + 16, 40, 16);
                ctx.fillRect(x - 16, y + 8, 16, 12);
                ctx.fillRect(x + 32, y + 8, 16, 12);
                ctx.fillStyle = glovesColor;
                ctx.fillRect(x - 24, y + 8, 12, 16);
                ctx.fillRect(x + 44, y + 8, 12, 16);
                ctx.fillStyle = skinColor;
                ctx.fillRect(x + 8, y, 20, 20);
                ctx.fillStyle = hairColor;
                ctx.fillRect(x + 8, y, 20, 8);
                ctx.fillStyle = shortsColor;
                ctx.fillRect(x, y + 32, 32, 8);
            } else {
                ctx.fillStyle = skinColor;
                ctx.fillRect(x + 8, y, 20, 20);
                ctx.fillStyle = hairColor;
                ctx.fillRect(x + 8, y, 20, 8);
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 12, y + 10, 4, 4);
                ctx.fillRect(x + 20, y + 10, 4, 4);
                ctx.fillStyle = shirtColor;
                ctx.fillRect(x + 4, y + 20, 28, 20);
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 16, y + 24, 4, 12);
                ctx.fillStyle = shirtColor;
                ctx.fillRect(x - 4, y + 20, 8, 16);
                ctx.fillRect(x + 32, y + 20, 8, 16);
                ctx.fillStyle = glovesColor;
                ctx.fillRect(x - 4, y + 32, 10, 10);
                ctx.fillRect(x + 30, y + 32, 10, 10);
                ctx.fillStyle = shortsColor;
                ctx.fillRect(x + 6, y + 40, 24, 10);
                ctx.fillStyle = skinColor;
                ctx.fillRect(x + 8, y + 50, 8, 12);
                ctx.fillRect(x + 20, y + 50, 8, 12);
                ctx.fillStyle = '#111';
                ctx.fillRect(x + 6, y + 60, 12, 6);
                ctx.fillRect(x + 18, y + 60, 12, 6);
            }
        }

        function drawDefender(x, y, number, skinColor) {
            const hairColor = '#1a1a1a';
            const shirtColor = '#c8102e';

            ctx.fillStyle = hairColor;
            ctx.fillRect(x + 6, y - 2, 20, 6);
            ctx.fillStyle = skinColor;
            ctx.fillRect(x + 6, y + 2, 20, 20);
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 10, y + 10, 5, 4);
            ctx.fillRect(x + 17, y + 10, 5, 4);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 12, y + 11, 2, 2);
            ctx.fillRect(x + 19, y + 11, 2, 2);
            ctx.fillStyle = shirtColor;
            ctx.fillRect(x + 2, y + 22, 28, 22);

            // Number
            ctx.fillStyle = '#fff';
            ctx.font = '10px monospace';
            ctx.fillText(number.toString(), x + 10, y + 38);

            ctx.fillStyle = shirtColor;
            ctx.fillRect(x - 4, y + 22, 8, 16);
            ctx.fillRect(x + 28, y + 22, 8, 16);
            ctx.fillStyle = skinColor;
            ctx.fillRect(x - 4, y + 36, 6, 6);
            ctx.fillRect(x + 30, y + 36, 6, 6);
            ctx.fillStyle = shirtColor;
            ctx.fillRect(x + 4, y + 44, 24, 12);
            ctx.fillStyle = skinColor;
            ctx.fillRect(x + 6, y + 56, 8, 14);
            ctx.fillRect(x + 18, y + 56, 8, 14);
            ctx.fillStyle = '#111';
            ctx.fillRect(x + 4, y + 68, 12, 6);
            ctx.fillRect(x + 16, y + 68, 12, 6);
        }

        function drawWall() {
            wallPlayers.forEach(p => {
                ctx.fillStyle = '#c8102e';
                ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.fillStyle = '#d4a574';
                ctx.fillRect(p.x + 4, p.y, 12, 12);
            });
        }

        function drawBall() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(ball.x + 2, ball.y + ball.radius + 4, ball.radius, ball.radius / 2, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(ball.x - 2, ball.y - 2, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawPowerMeter() {
            if (shotCharging) {
                const meterWidth = 100;
                const meterHeight = 12;
                const x = salah.x - 20;
                const y = salah.y - 30;
                const fillWidth = (shotPower / maxShotPower) * meterWidth;

                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(x - 2, y - 2, meterWidth + 4, meterHeight + 4);

                const powerPercent = shotPower / maxShotPower;
                ctx.fillStyle = powerPercent < 0.5 ? '#4ade80' : powerPercent < 0.75 ? '#fbbf24' : '#ef4444';
                ctx.fillRect(x, y, fillWidth, meterHeight);

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, meterWidth, meterHeight);

                ctx.fillStyle = '#fff';
                ctx.font = '8px monospace';
                ctx.fillText('POWER', x + 30, y - 5);
            }
        }

        function drawBendMeter() {
            if (gameState === 'bendSelect') {
                const meterWidth = 200;
                const meterHeight = 20;
                const x = canvas.width / 2 - meterWidth / 2;
                const y = 50;

                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(x - 5, y - 25, meterWidth + 10, meterHeight + 35);

                // Gradient for bend
                const gradient = ctx.createLinearGradient(x, 0, x + meterWidth, 0);
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(0.5, '#4ade80');
                gradient.addColorStop(1, '#f59e0b');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, meterWidth, meterHeight);

                // Indicator
                const indicatorX = x + (bendAmount / 100) * meterWidth;
                ctx.fillStyle = '#fff';
                ctx.fillRect(indicatorX - 3, y - 5, 6, meterHeight + 10);

                ctx.fillStyle = '#fff';
                ctx.font = '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('LEFT          STRAIGHT          RIGHT', x + meterWidth / 2, y - 10);
                ctx.fillText('TAP SHOOT TO CONFIRM', x + meterWidth / 2, y + meterHeight + 15);
                ctx.textAlign = 'left';
            }
        }

        function drawCelebration() {
            if (gameState === 'celebrating') {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < 20; i++) {
                    ctx.fillStyle = ['#c8102e', '#ffd700', '#fff'][Math.floor(Math.random() * 3)];
                    ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 8, 8);
                }
            }
        }

        function updateGame() {
            if (gameState === 'menu' || gameState === 'levelComplete' || gameState === 'gameOver') return;

            // Update shot power
            if (shotCharging) {
                shotPower = Math.min(maxShotPower, (Date.now() - chargeStartTime) / 10);
            }

            // Update bend oscillation
            if (gameState === 'bendSelect') {
                bendAmount += bendDirection * 1.5;
                if (bendAmount >= 100 || bendAmount <= 0) bendDirection *= -1;
            }

            const level = levels[currentLevel];

            // Move Salah (not in free kick)
            if (gameState === 'playing' && !level.freeKick) {
                if ((keys['arrowleft'] || keys['a']) && salah.x > 50) salah.x -= salah.speed;
                if ((keys['arrowright'] || keys['d']) && salah.x < 600) salah.x += salah.speed;
                if ((keys['arrowup'] || keys['w']) && salah.y > 50) salah.y -= salah.speed;
                if ((keys['arrowdown'] || keys['s']) && salah.y < 420) salah.y += salah.speed;

                if (touchMove.x !== 0 || touchMove.y !== 0) {
                    const newX = salah.x + touchMove.x * salah.speed;
                    const newY = salah.y + touchMove.y * salah.speed;
                    if (newX > 50 && newX < 600) salah.x = newX;
                    if (newY > 50 && newY < 420) salah.y = newY;
                }

                if (salah.hasBall) {
                    ball.x = salah.x + 20;
                    ball.y = salah.y + 45;
                }

                // Defenders chase
                level.defenders.forEach(defName => {
                    const def = defenders[defName];
                    if (!def) return;
                    const dx = salah.x - def.x;
                    const dy = salah.y - def.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 5) {
                        def.x += (dx / dist) * def.speed;
                        def.y += (dy / dist) * def.speed;
                    }
                    if (salah.hasBall && dist < def.tackleRange) {
                        handleTackle(defName);
                    }
                });
            }

            // Update ball
            if (ball.active) {
                ball.x += ball.velocityX;
                ball.y += ball.velocityY;
                ball.velocityY += ball.curve; // Apply curve

                // Check wall collision (free kick)
                if (level.freeKick) {
                    for (const p of wallPlayers) {
                        if (ball.x > p.x && ball.x < p.x + p.width + 10 &&
                            ball.y > p.y && ball.y < p.y + p.height) {
                            ball.velocityX *= -0.3;
                            ball.velocityY = (Math.random() - 0.5) * 8;
                            document.getElementById('message').textContent = 'Blocked by the wall!';
                            gameState = 'saved';
                            setTimeout(() => handleMiss(false), 1000);
                            break;
                        }
                    }
                }

                // Goal check
                if (ball.x >= goal.x && ball.y > goal.y + goal.postWidth && ball.y < goal.y + goal.height - goal.postWidth) {
                    if (gameState === 'shooting') handleGoal();
                }

                // Save check
                if (ball.x > alisson.x - 20 && ball.x < alisson.x + alisson.width + 20 &&
                    ball.y > alisson.y - 10 && ball.y < alisson.y + alisson.height + 20) {
                    if (gameState === 'shooting') {
                        ball.velocityX = -ball.velocityX * 0.5;
                        ball.velocityY = (Math.random() - 0.5) * 5;
                        handleMiss(true);
                    }
                }

                // Out of bounds
                if (ball.x > canvas.width || ball.y < 0 || ball.y > canvas.height) {
                    if (gameState === 'shooting') handleMiss(false);
                }

                ball.velocityX *= 0.995;
                ball.velocityY *= 0.995;
            }

            // Update Alisson
            if (alisson.diving) {
                alisson.diveFrame++;
                const targetY = Math.max(goal.y, Math.min(goal.y + goal.height - alisson.height, alisson.targetY));
                alisson.y += (targetY - alisson.y) * 0.15;
            } else if (gameState === 'playing' || gameState === 'freeKick' || gameState === 'bendSelect') {
                const targetY = ball.y - alisson.height / 2;
                const clampedTarget = Math.max(goal.y, Math.min(goal.y + goal.height - alisson.height, targetY));
                alisson.y += (clampedTarget - alisson.y) * level.keeperSpeed;
            }

            if (salah.kickFrame > 0) salah.kickFrame--;
            if (salah.celebrating) salah.celebrateFrame++;
        }

        function gameLoop() {
            updateGame();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawField();

            const level = levels[currentLevel];

            // Draw wall for free kicks
            if (level?.freeKick && wallPlayers.length > 0) {
                drawWall();
            }

            // Draw defenders
            if (level && !level.freeKick) {
                level.defenders.forEach(defName => {
                    const def = defenders[defName];
                    if (def) drawDefender(def.x, def.y, def.number, def.skin);
                });
            }

            drawSalah(salah.x, salah.y);
            drawAlisson(alisson.x, alisson.y, alisson.diving, alisson.diveDirection);
            drawBall();
            drawPowerMeter();
            drawBendMeter();
            drawCelebration();

            requestAnimationFrame(gameLoop);
        }

        // Menu handlers
        document.getElementById('startBtn').addEventListener('click', () => {
            playerName = document.getElementById('playerName').value.trim() || 'PLAYER';
            document.getElementById('startOverlay').classList.add('hidden');
            totalScore = 0;
            lives = 5;
            document.getElementById('totalScore').textContent = '0';
            startLevel(0);
        });

        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            // Show ad between levels (every other level for better UX)
            if (currentLevel > 0 && currentLevel % 2 === 0) {
                showAd(() => {
                    startLevel(currentLevel + 1);
                });
            } else {
                startLevel(currentLevel + 1);
            }
        });

        document.getElementById('extraLifeBtn').addEventListener('click', () => {
            showRewardedAd(() => {
                lives++;
                document.getElementById('message').textContent = '+1 LIFE! You now have ' + lives + ' lives!';
            });
        });

        document.getElementById('continueAdBtn').addEventListener('click', () => {
            showRewardedAd(() => {
                // Give player another chance
                document.getElementById('gameOverOverlay').classList.add('hidden');
                lives = 1;
                resetPositions();
            });
        });

        document.getElementById('playAgainBtn').addEventListener('click', () => {
            // Show ad on replay
            showAd(() => {
                document.getElementById('gameOverOverlay').classList.add('hidden');
                totalScore = 0;
                lives = 5;
                document.getElementById('totalScore').textContent = '0';
                startLevel(0);
            });
        });

        document.getElementById('mainMenuBtn').addEventListener('click', () => {
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('startOverlay').classList.remove('hidden');
            displayLeaderboard('leaderboard');
        });

        // Initialize
        displayLeaderboard('leaderboard');
        gameLoop();
    </script>
</body>
</html>
